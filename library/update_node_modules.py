import sublime
from ..import_helper import PROJECT_NAME
from .debug import debug
from .utils import error_message, status_message
from .get_exclude_patterns import get_exclude_patterns
from .get_import_root import get_import_root
from .exec_command import run_command_async


def update_node_modules(node_modules=[]):
    node_modules.clear()
    import_root = get_import_root()
    debug("update_node_modules:import_root", import_root)

    def callback(err, result):
        get_modules_callback(err, result, node_modules)

    run_command_async("exportsNodeModules", {"directory": import_root}, callback)


def get_modules_callback(err, result, node_modules):
    if err:
        return error_message(err)
    if type(result) is not list:
        return error_message("Unexpected type of result: {0}".format(type(result)))
    node_modules.extend(result)
    count = len(result)
    debug("get_modules_callback:result.length", count)
    status_message("{0} node modules found".format(count))
